- name: individualize the nomad servers
  hosts: nomad_prod
  vars_files: ../secrets/secrets.yaml
  gather_facts: no
  tasks:
  - name: set become password
    set_fact: ansible_become_pass='{{ nomad_password }}'

  - name: create a  unique node id based on the hostname
    become: yes
    copy:
      mode: 0600
      dest: /opt/consul/node-id
      owner: consul
      group: consul
      content: '{{ inventory_hostname | to_uuid }}'

  - name: create a  unique nomad client id based on the hostname
    become: yes
    copy:
      mode: 0600
      dest: /opt/nomad/client/client-id
      owner: nomad
      group: nomad
      content: '{{ inventory_hostname | to_uuid }}'

  - name: restart consul & nomad service
    become: yes
    systemd:
      name: '{{ item }}'
      state: restarted
    with_items:
      - consul
      - nomad